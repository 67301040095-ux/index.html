<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Real Pipe Flow</title>
<style>
body{margin:0;overflow:hidden;background:#1e2228;}
button{
position:fixed;
top:20px;
left:20px;
padding:10px 20px;
font-size:16px;
z-index:10;
}
</style>
</head>
<body>

<button onclick="startSystem()">START SYSTEM</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/controls/OrbitControls.js"></script>

<script>

const scene = new THREE.Scene();
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth,window.innerHeight);
renderer.shadowMap.enabled = true;
document.body.appendChild(renderer.domElement);

const camera = new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,0.1,3000);
camera.position.set(0,300,700);

const controls = new THREE.OrbitControls(camera,renderer.domElement);
controls.enableDamping = true;

scene.add(new THREE.AmbientLight(0xffffff,0.6));
const light = new THREE.DirectionalLight(0xffffff,1);
light.position.set(300,400,200);
light.castShadow=true;
scene.add(light);

const ground = new THREE.Mesh(
new THREE.PlaneGeometry(1000,800),
new THREE.MeshStandardMaterial({color:0xf0f0f0})
);
ground.rotation.x = -Math.PI/2;
ground.receiveShadow = true;
scene.add(ground);

// ===== BOX =====
function box(x,z,color){
const m = new THREE.Mesh(
new THREE.BoxGeometry(80,80,80),
new THREE.MeshStandardMaterial({color:color})
);
m.position.set(x,40,z);
m.castShadow=true;
scene.add(m);
}

box(-300,-200,0xaaaaaa); // CT
box(300,-200,0xddddcc);  // AHU
box(-300,0,0x000000);    // CDP
box(300,0,0x000000);     // CHP
box(0,-100,0xcccccc);    // CH

// ===== CREATE PIPE (L SHAPE) =====
function createPipe(points,color){

const curve = new THREE.CatmullRomCurve3(points);
const geometry = new THREE.TubeGeometry(curve,100,6,16,false);

const material = new THREE.MeshStandardMaterial({color:color});
const mesh = new THREE.Mesh(geometry,material);
mesh.castShadow=true;
scene.add(mesh);

return curve;
}

// ===== PATHS ตามรูปคุณ =====

// ซ้ายบน → กลาง
const curve1 = createPipe([
new THREE.Vector3(-300,15,-200),
new THREE.Vector3(-300,15,-150),
new THREE.Vector3(0,15,-150),
new THREE.Vector3(0,15,-100)
],0xff0000);

// ซ้ายล่าง → กลาง
const curve2 = createPipe([
new THREE.Vector3(-300,15,0),
new THREE.Vector3(-300,15,-50),
new THREE.Vector3(0,15,-50),
new THREE.Vector3(0,15,-100)
],0xffaa00);

// กลาง → ขวาบน
const curve3 = createPipe([
new THREE.Vector3(0,15,-100),
new THREE.Vector3(0,15,-150),
new THREE.Vector3(300,15,-150),
new THREE.Vector3(300,15,-200)
],0x0000ff);

// กลาง → ขวาล่าง
const curve4 = createPipe([
new THREE.Vector3(0,15,-100),
new THREE.Vector3(0,15,-50),
new THREE.Vector3(300,15,-50),
new THREE.Vector3(300,15,0)
],0x00ff00);

// ===== BALL FLOW =====
function createBallFlow(curve,color){

const balls=[];
for(let i=0;i<5;i++){
const b = new THREE.Mesh(
new THREE.SphereGeometry(7,32,32),
new THREE.MeshStandardMaterial({
color:color,
emissive:color,
emissiveIntensity:0.7
})
);
scene.add(b);
balls.push({mesh:b,offset:i*0.2});
}

return function(progress){
balls.forEach(obj=>{
let t = progress-obj.offset;
if(t<0)t=0;
if(t>1)t=1;
obj.mesh.position.copy(curve.getPointAt(t));
});
}
}

const flow1 = createBallFlow(curve1,0xffff00);
const flow2 = createBallFlow(curve2,0xffff00);
const flow3 = createBallFlow(curve3,0x00ffff);
const flow4 = createBallFlow(curve4,0x00ffff);

let progress=0;
let running=false;

function startSystem(){
running=true;
progress=0;
}

function animate(){
requestAnimationFrame(animate);

if(running){
progress+=0.003;
if(progress>1)progress=1;
flow1(progress);
flow2(progress);
flow3(progress);
flow4(progress);
}

controls.update();
renderer.render(scene,camera);
}
animate();

window.addEventListener("resize",()=>{
camera.aspect=window.innerWidth/window.innerHeight;
camera.updateProjectionMatrix();
renderer.setSize(window.innerWidth,window.innerHeight);
});

</script>
</body>
</html>
