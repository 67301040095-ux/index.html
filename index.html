<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Modern Chiller Plant 3D - Clean Version</title>
<style>
body { margin:0; overflow:hidden; background:#eef1f5; }
button{
  position:fixed;
  top:20px;
  left:20px;
  padding:10px 20px;
  font-size:16px;
  z-index:10;
}
</style>
</head>
<body>

<button onclick="startSystem()">START SYSTEM</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/controls/OrbitControls.js"></script>

<script>

// ================= SCENE =================
const scene = new THREE.Scene();

const camera = new THREE.PerspectiveCamera(
60,
window.innerWidth/window.innerHeight,
0.1,
2000
);
camera.position.set(160,100,220);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth,window.innerHeight);
renderer.shadowMap.enabled = true;
document.body.appendChild(renderer.domElement);

const controls = new THREE.OrbitControls(camera,renderer.domElement);
controls.enableDamping = true;

// ================= LIGHT =================
scene.add(new THREE.AmbientLight(0xffffff,0.6));

const light = new THREE.DirectionalLight(0xffffff,0.8);
light.position.set(200,200,100);
light.castShadow = true;
scene.add(light);

// ================= MATERIAL =================
const whiteMat = new THREE.MeshStandardMaterial({color:0xffffff,metalness:0.3,roughness:0.4});
const metalMat = new THREE.MeshStandardMaterial({color:0xd0d5db,metalness:0.8,roughness:0.3});
const darkMat  = new THREE.MeshStandardMaterial({color:0x555b66,metalness:0.7,roughness:0.4});
const accentMat= new THREE.MeshStandardMaterial({color:0x2d6cdf,metalness:0.6,roughness:0.3});

// ================= GROUND =================
const ground = new THREE.Mesh(
new THREE.PlaneGeometry(600,600),
new THREE.MeshStandardMaterial({color:0xffffff})
);
ground.rotation.x = -Math.PI/2;
ground.receiveShadow = true;
scene.add(ground);

// ================= COOLING TOWER =================
function createCT(x,z){
const group = new THREE.Group();

const base = new THREE.Mesh(new THREE.BoxGeometry(28,4,28),metalMat);
base.position.y = 2;
group.add(base);

const body = new THREE.Mesh(new THREE.BoxGeometry(22,36,22),whiteMat);
body.position.y = 22;
group.add(body);

for(let i=-10;i<=10;i+=4){
const line = new THREE.Mesh(new THREE.BoxGeometry(22,0.4,0.6),metalMat);
line.position.set(0,20+i,11.5);
group.add(line);
}

const hub = new THREE.Mesh(new THREE.CylinderGeometry(2,2,2,32),darkMat);
hub.rotation.x = Math.PI/2;
hub.position.y = 42;
group.add(hub);

const blades = new THREE.Group();
for(let i=0;i<6;i++){
const blade = new THREE.Mesh(new THREE.BoxGeometry(10,1,3),darkMat);
blade.position.x = 8;
blade.rotation.y = Math.PI/10;
const pivot = new THREE.Group();
pivot.add(blade);
pivot.rotation.y = (i/6)*Math.PI*2;
blades.add(pivot);
}
blades.rotation.y = Math.PI/2;
blades.position.y = 42;
group.add(blades);

group.position.set(x,0,z);
scene.add(group);
return blades;
}

// ================= CHILLER =================
function createChiller(x,z){
const group = new THREE.Group();

const barrel1 = new THREE.Mesh(new THREE.CylinderGeometry(8,8,65,32),whiteMat);
barrel1.rotation.z = Math.PI/2;
barrel1.position.y = 12;
group.add(barrel1);

const barrel2 = barrel1.clone();
barrel2.position.y = 24;
group.add(barrel2);

for(let i=-18;i<=18;i+=36){
const saddle = new THREE.Mesh(new THREE.BoxGeometry(28.8,4,20),metalMat);
saddle.position.set(i,6,0);
group.add(saddle);
}

const panel = new THREE.Mesh(new THREE.BoxGeometry(14,10,2),accentMat);
panel.position.set(0,18,8);
group.add(panel);

group.position.set(x,0,z);
scene.add(group);
}

// ================= PUMP =================
function createPump(x,z){
const group = new THREE.Group();

const base = new THREE.Mesh(new THREE.BoxGeometry(22,2,14),darkMat);
base.position.y = 1;
group.add(base);

const lower = new THREE.Mesh(new THREE.BoxGeometry(6,8,6),metalMat);
lower.position.y = 6;
group.add(lower);

const volute = new THREE.Mesh(new THREE.CylinderGeometry(6,6,6,32),whiteMat);
volute.position.y = 11;
group.add(volute);

const suction = new THREE.Mesh(new THREE.CylinderGeometry(2.5,2.5,8,32),metalMat);
suction.rotation.x = Math.PI/2;
suction.position.set(0,11,7);
group.add(suction);

const discharge = new THREE.Mesh(new THREE.CylinderGeometry(2.5,2.5,8,32),metalMat);
discharge.rotation.x = Math.PI/2;
discharge.position.set(0,11,-7);
group.add(discharge);

const motor = new THREE.Mesh(new THREE.CylinderGeometry(5,5,10,32),accentMat);
motor.position.y = 18;
group.add(motor);

const cap = new THREE.Mesh(new THREE.CylinderGeometry(5,5,2,32),darkMat);
cap.position.y = 24;
group.add(cap);

group.position.set(x,0,z);
scene.add(group);
}

// ================= AHU =================
function createAHU(x, z){

    const group = new THREE.Group();

    // ===== ตัวเครื่อง =====
    const body = new THREE.Mesh(
        new THREE.BoxGeometry(70,20,22),
        whiteMat
    );
    body.position.x = 12;
    group.add(body);


    // ===== วงแหวนช่องพัดลม =====
    const ring = new THREE.Mesh(
        new THREE.CylinderGeometry(8,8,2,32),
        new THREE.MeshStandardMaterial({ color: 0x444444 })
    );
    ring.rotation.x = Math.PI / 2;   // ให้หันออกด้านหน้า
    ring.position.set(-25,12,12);    // ตำแหน่งด้านหน้า
    group.add(ring);

    // ===== ใบพัด =====
    const fanGroup = new THREE.Group();
    const bladeMat = new THREE.MeshStandardMaterial({ color: 0x222222 });
    for(let i=0;i<4;i++){
        const blade = new THREE.Mesh(
            new THREE.BoxGeometry(1.5,12,2),
            bladeMat
        );
        blade.position.y = 0;
        blade.rotation.z = i * Math.PI / 2;
        fanGroup.add(blade);
    }

    fanGroup.rotation.x = Math.PI / 2;
    fanGroup.position.set(-25,12,13);
    group.add(fanGroup);

    // เก็บ fan ไว้ควบคุมตอน animate
    group.userData.fan = fanGroup;
    group.position.set(x,0,z);
    scene.add(group);

    return group;   // สำคัญ! ต้อง return
}

// ================= FLOW DOT SYSTEM =================
function createFlow(pathPoints, color = 0x00aaff, speed = 0.002) {

    const curve = new THREE.CatmullRomCurve3(pathPoints);
    
    const geometry = new THREE.SphereGeometry(2, 16, 16);
    const material = new THREE.MeshStandardMaterial({
        color: color,
        emissive: color,
        emissiveIntensity: 1
    });

    const dot = new THREE.Mesh(geometry, material);
    scene.add(dot);

    let t = 0;

    function animateFlow() {
        t += speed;
        if (t > 1) t = 0;
        const position = curve.getPointAt(t);
        dot.position.copy(position);
    }

    return animateFlow;
}
  
// ================= LAYOUT =================
const fan1 = createCT(-140,-70);
const fan2 = createCT(-110,-70);

[-120,-100,-80].forEach(x => createPump(x,-10));
createChiller(0,-20);
createChiller(0,-70);
[80,100,120].forEach(x => createPump(x,-10));
createAHU(160,-60);

// ================= FLOW PATH =================

const supplyFlow = createFlow([

    new THREE.Vector3(-150, 5, -60),  // CT
    new THREE.Vector3(-120, 5, -20),  // CDP
    new THREE.Vector3(0, 5, -60),     // CH
    new THREE.Vector3(0, 5, -20),     // CHP
    new THREE.Vector3(150, 5, -60)    // AHU

], 0xff8800, 0.0008);

const returnFlow = createFlow([

    new THREE.Vector3(150, 5, -60),   // AHU
    new THREE.Vector3(0, 5, -60),     // CH
    new THREE.Vector3(-150, 5, -60)   // CT

], 0x0088ff, 0.0008);
  
// ================= SYSTEM =================
let systemOn = false;
let fanSpeed = 0;

function startSystem(){
setTimeout(()=>{ systemOn = true; },2000);
}

function animate(){
requestAnimationFrame(animate);
if(systemOn){
    fanSpeed = 0.1;
    supplyFlow();
    returnFlow();
}

fan1.rotation.y -= fanSpeed;
fan2.rotation.y -= fanSpeed;
controls.update();
renderer.render(scene,camera);
}
animate();

window.addEventListener("resize",()=>{
camera.aspect = window.innerWidth/window.innerHeight;
camera.updateProjectionMatrix();
renderer.setSize(window.innerWidth,window.innerHeight);
});

</script>
</body>
</html>
